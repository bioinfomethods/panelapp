version: '3'

services:

  db:
    image: postgres:9.6.9
    environment:
      - POSTGRES_PASSWORD=panelapp
      - POSTGRES_USER=panelapp
      - POSTGRES_DB=panelapp

  # FIXME Remove nginx
  nginx:
    image: nginx:1.15.1
    ports:
      - "8090:80"
    volumes:
      - ../../deploy/nginx.conf:/etc/nginx/conf.d/default.conf
      - /tmp/panelapp_static:/static
      - /tmp/panelapp_media:/media
    depends_on:
      - web

  rabbitmq:
    image: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_VHOST=panelapp

  web:
    build:
      context: .
      dockerfile: Dockerfile-web
    image: panelapp_web_dev
    restart: on-failure
    volumes:
      - ../../panelapp:/app/panelapp
      - /tmp/panelapp_static:/static
      - /tmp/panelapp_media:/media
    ports:
      - "8000:8000"
    depends_on:
      - db
      - rabbitmq
    environment:
      - DATABASE_URL=postgres://panelapp:panelapp@db/panelapp
      - DJANGO_SETTINGS_MODULE=panelapp.settings.docker-dev
      - DJANGO_LOG_LEVEL=DEBUG
      - HEALTH_ACCESS_TOKEN_LOCATION=/app/health_token
      - CELERY_BROKER_URL=amqp://rabbitmq/panelapp
      - ALLOWED_HOSTS=localhost;web
      - STATIC_ROOT=/static
      - MEDIA_ROOT=/media

  celery_worker:
    build:
      context: .
      dockerfile: Dockerfile-backend
    image: panelapp_backend_dev
    restart: on-failure
    volumes:
      - ../../panelapp:/app/panelapp
      - /tmp/panelapp_static:/static
      - /tmp/panelapp_media:/media
    ports: []
    depends_on:
      - db
      - rabbitmq
    environment:
      # FIXME do we need all the following?
      - DATABASE_URL=postgres://panelapp:panelapp@db/panelapp
      - DJANGO_SETTINGS_MODULE=panelapp.settings.docker-dev
      - HEALTH_ACCESS_TOKEN_LOCATION=/app/health_token
      - CELERY_BROKER_URL=amqp://rabbitmq/panelapp
      - ALLOWED_HOSTS=localhost;web
      - STATIC_ROOT=/static
