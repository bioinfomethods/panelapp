name: Main workflow, test and deploy to AWS

on:
  push:
    branches:
      - reports-bucket-proxy-test

permissions:
  id-token: write
  contents: read

jobs:
  init:
    name: "init"
    runs-on: ubuntu-latest
    steps:
      - name: GitHub Environment Variables Action
        uses: FranzDiebold/github-env-vars-action@v2.8.0

      - id: init_env
        shell: bash
        run: |
          echo "CI_ACTION_REF_NAME_SLUG=$CI_ACTION_REF_NAME_SLUG"
          echo "CI_SHA_SHORT=$CI_SHA_SHORT"
          # Branch Selection

          if [ "$CI_ACTION_REF_NAME_SLUG" == " reports-bucket-proxy" ]; then
            echo "env_name=staging" >> "$GITHUB_OUTPUT"
            echo "github_actions_environment=mcri-vcgs-staging" >> "$GITHUB_OUTPUT"
          fi
          echo "env_name=$env_name"
          echo "GITHUB_OUTPUT=$GITHUB_OUTPUT"

      - name: Log outputs
        run: |
          echo "CI_ACTION_REF_NAME_SLUG=$CI_ACTION_REF_NAME_SLUG"
          echo "CI_SHA_SHORT=$CI_SHA_SHORT"
          echo "env_name=${{ steps.init_env.outputs.env_name }}"
          echo "github_actions_environment=${{ steps.init_env.outputs.github_actions_environment }}"

    outputs:
      env_name: ${{ steps.init_env.outputs.env_name }}
      github_actions_environment: ${{ steps.init_env.outputs.github_actions_environment }}

  tests:
    needs: init
    environment: ${{ needs.init.outputs.github_actions_environment }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ 3.9 ]
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_DB: panelapp
          POSTGRES_USER: panelapp
          POSTGRES_PASSWORD: secret
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U panelapp -d panelapp"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      POSTGRES_DB: panelapp
      POSTGRES_USER: panelapp
      POSTGRES_PASSWORD: secret
      DATABASE_URL: postgres://panelapp:secret@localhost:5432/panelapp
      DJANGO_SETTINGS_MODULE: panelapp.settings.test
      DJANGO_LOG_LEVEL: INFO
    steps:
      - name: GitHub Environment Variables Action
        uses: FranzDiebold/github-env-vars-action@v2.8.0

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          echo "CI_ACTION_REF_NAME_SLUG=$CI_ACTION_REF_NAME_SLUG"
          echo "CI_SHA_SHORT=$CI_SHA_SHORT"
          sudo apt-get install -y libpq-dev gcc python3-dev
          pip install pip==23.3.2
          pip install .[dev,tests]
          pip install setuptools==58.1.0

      - name: Run tests
        run: pytest
